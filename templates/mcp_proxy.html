<!DOCTYPE html>
<html>
<head>
    <title>MCP Browser Proxy - bluep</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ddd;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #222;
            border-radius: 8px;
        }
        
        .status {
            padding: 20px;
            background: #282828;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status.connected {
            border-left: 4px solid #4CAF50;
        }
        
        .status.disconnected {
            border-left: 4px solid #f44336;
        }
        
        .proxy-info {
            margin: 20px 0;
            padding: 20px;
            background: #282828;
            border-radius: 8px;
        }
        
        .service-selector {
            margin: 20px 0;
        }
        
        .service-selector select {
            width: 100%;
            padding: 10px;
            background: #333;
            color: #ddd;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .logs {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .log-entry.info { color: #888; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.error { color: #f44336; }
        .log-entry.request { color: #2196F3; }
        .log-entry.response { color: #9C27B0; }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #333;
            color: #ddd;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #444;
        }
        
        .btn.primary {
            background: #2196F3;
            border-color: #2196F3;
        }
        
        .btn.primary:hover {
            background: #1976D2;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .config-section {
            margin: 20px 0;
            padding: 20px;
            background: #282828;
            border-radius: 8px;
        }
        
        .code-block {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            position: relative;
            margin: 10px 0;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 3px;
            color: #ddd;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #444;
        }
        
        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .message.success {
            background: #1b5e20;
            color: #4CAF50;
        }
        
        .message.error {
            background: #b71c1c;
            color: #fff;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            flex: 1;
            background: #282828;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MCP Browser Proxy</h1>
            <p>Access remote MCP services directly from your browser</p>
        </div>
        
        <div id="status" class="status disconnected">
            <h3>Connection Status</h3>
            <div id="status-text">Disconnected</div>
        </div>
        
        <div class="service-selector">
            <h3>Select MCP Service</h3>
            <select id="service-select" disabled>
                <option value="">Loading services...</option>
            </select>
        </div>
        
        <div class="controls">
            <button id="start-proxy" class="btn primary" disabled>Start Proxy</button>
            <button id="stop-proxy" class="btn" disabled>Stop Proxy</button>
            <button id="clear-logs" class="btn">Clear Logs</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="requests-count">0</div>
                <div class="stat-label">Requests</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="responses-count">0</div>
                <div class="stat-label">Responses</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="errors-count">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>
        
        <div class="proxy-info" id="proxy-info" style="display: none;">
            <h3>Proxy Configuration</h3>
            <p>Your MCP proxy is running. Configure Claude Code with:</p>
            <div class="code-block">
                <pre id="claude-config">{
  "mcpServers": {
    "SERVICE_NAME": {
      "command": "curl",
      "args": ["-X", "POST", "-H", "Content-Type: application/json", "-d", "@-", "http://localhost:4000"],
      "env": {}
    }
  }
}</pre>
                <button class="copy-btn" onclick="copyConfig()">Copy</button>
            </div>
            <p>Or use the WebSocket bridge URL directly: <code id="ws-bridge-url">ws://localhost:4000</code></p>
        </div>
        
        <div class="logs-section">
            <h3>Proxy Logs</h3>
            <div id="logs" class="logs"></div>
        </div>
    </div>
    
    <script>
        // Global state
        let ws = null;
        let wsToken = "{{token}}";
        let services = [];
        let selectedService = null;
        let proxyRunning = false;
        let bridgeServer = null;
        let stats = {
            requests: 0,
            responses: 0,
            errors: 0
        };
        
        // Initialize WebSocket connection to bluep
        function initWebSocket() {
            const wsUrl = `wss://${window.location.host}/ws?token=${encodeURIComponent(wsToken)}`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateStatus('Connected to bluep', true);
                ws.send(JSON.stringify({ type: 'mcp-service-list' }));
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
            
            ws.onerror = (error) => {
                updateStatus('Connection error', false);
                addLog('WebSocket error: ' + error, 'error');
            };
            
            ws.onclose = () => {
                updateStatus('Disconnected from bluep', false);
                setTimeout(initWebSocket, 3000);
            };
        }
        
        // Handle messages from bluep
        function handleMessage(msg) {
            switch (msg.type) {
                case 'mcp-service-list':
                    services = msg.mcpServices || [];
                    updateServiceList();
                    break;
                    
                case 'mcp-response':
                    // Forward response to local bridge
                    if (bridgeServer && bridgeServer.pendingRequests[msg.requestId]) {
                        const { resolve } = bridgeServer.pendingRequests[msg.requestId];
                        delete bridgeServer.pendingRequests[msg.requestId];
                        resolve(msg.mcpPayload);
                        stats.responses++;
                        updateStats();
                        addLog(`Response for request ${msg.requestId}`, 'response');
                    }
                    break;
                    
                case 'error':
                    addLog('Server error: ' + msg.error, 'error');
                    stats.errors++;
                    updateStats();
                    break;
            }
        }
        
        // Update service dropdown
        function updateServiceList() {
            const select = document.getElementById('service-select');
            select.innerHTML = '<option value="">Select a service...</option>';
            
            services.forEach(service => {
                if (service.status === 'running' || (service.type === 'external' && service.status === 'running')) {
                    const option = document.createElement('option');
                    option.value = service.name;
                    option.textContent = `${service.name} (${service.type || 'local'})`;
                    select.appendChild(option);
                }
            });
            
            select.disabled = false;
            document.getElementById('start-proxy').disabled = false;
        }
        
        // Start the local WebSocket bridge
        async function startProxy() {
            selectedService = document.getElementById('service-select').value;
            if (!selectedService) {
                showMessage('Please select a service', 'error');
                return;
            }
            
            try {
                // Create a simple HTTP server that forwards to WebSocket
                await startBridgeServer();
                
                proxyRunning = true;
                document.getElementById('start-proxy').disabled = true;
                document.getElementById('stop-proxy').disabled = false;
                document.getElementById('service-select').disabled = true;
                
                // Update config display
                document.getElementById('claude-config').textContent = JSON.stringify({
                    mcpServers: {
                        [selectedService]: {
                            command: "curl",
                            args: ["-X", "POST", "-H", "Content-Type: application/json", "-d", "@-", "http://localhost:4000"],
                            env: {}
                        }
                    }
                }, null, 2);
                
                document.getElementById('proxy-info').style.display = 'block';
                addLog(`Proxy started for service: ${selectedService}`, 'success');
                
            } catch (error) {
                addLog('Failed to start proxy: ' + error.message, 'error');
                showMessage('Failed to start proxy', 'error');
            }
        }
        
        // Start a local bridge server using Service Worker or WebSocket
        async function startBridgeServer() {
            // For browser-based solution, we'll use a WebSocket bridge approach
            // This creates a local WebSocket server that Claude Code can connect to
            
            bridgeServer = {
                pendingRequests: {},
                requestCounter: 0
            };
            
            // Note: In a real implementation, we'd need a browser extension or 
            // a local companion app to create a true HTTP server on port 4000.
            // For now, we'll document the architecture and show what would be needed.
            
            addLog('Bridge server started (simulation mode)', 'info');
            addLog('Note: Full browser-based proxy requires a companion browser extension', 'info');
        }
        
        // Stop the proxy
        function stopProxy() {
            proxyRunning = false;
            bridgeServer = null;
            
            document.getElementById('start-proxy').disabled = false;
            document.getElementById('stop-proxy').disabled = true;
            document.getElementById('service-select').disabled = false;
            document.getElementById('proxy-info').style.display = 'none';
            
            addLog('Proxy stopped', 'info');
        }
        
        // Forward MCP request through WebSocket
        function forwardRequest(payload) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                throw new Error('WebSocket not connected');
            }
            
            const requestId = `req_${Date.now()}_${bridgeServer.requestCounter++}`;
            
            return new Promise((resolve, reject) => {
                bridgeServer.pendingRequests[requestId] = { resolve, reject };
                
                ws.send(JSON.stringify({
                    type: 'mcp-request',
                    serviceName: selectedService,
                    mcpPayload: payload,
                    requestId: requestId
                }));
                
                stats.requests++;
                updateStats();
                addLog(`Request ${requestId} forwarded to ${selectedService}`, 'request');
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (bridgeServer.pendingRequests[requestId]) {
                        delete bridgeServer.pendingRequests[requestId];
                        reject(new Error('Request timeout'));
                        stats.errors++;
                        updateStats();
                    }
                }, 30000);
            });
        }
        
        // UI Helper Functions
        function updateStatus(text, connected) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
            statusText.textContent = text;
        }
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function updateStats() {
            document.getElementById('requests-count').textContent = stats.requests;
            document.getElementById('responses-count').textContent = stats.responses;
            document.getElementById('errors-count').textContent = stats.errors;
        }
        
        function copyConfig() {
            const config = document.getElementById('claude-config').textContent;
            navigator.clipboard.writeText(config).then(() => {
                showMessage('Configuration copied to clipboard', 'success');
            });
        }
        
        function showMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.querySelector('.header').after(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        // Event listeners
        document.getElementById('start-proxy').addEventListener('click', startProxy);
        document.getElementById('stop-proxy').addEventListener('click', stopProxy);
        document.getElementById('clear-logs').addEventListener('click', clearLogs);
        
        // Initialize
        initWebSocket();
    </script>
</body>
</html>